<!DOCTYPE html>
<html lang="ru">
<head>
    <style type="text/css">
        form {
            border: 3px solid #7922CC;
        }
        table {
            font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
            font-size: 14px;
            border-collapse: collapse;
            text-align: center;
        }
        caption {
            font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
            font-size: 16px;
            border-collapse: collapse;
            text-align: center;
            background: #AFCDE7;
            color: white;
            padding: 10px 20px;
            border-style: solid;
            border-width: 0 1px 1px 0;
            border-color: white;
        }
        th, td:first-child {
            background: #AFCDE7;
            color: white;
            padding: 10px 20px;
        }

        th, td {
            border-style: solid;
            border-width: 0 1px 1px 0;
            border-color: white;
        }

        td {
            background: #D8E6F3;
        }
        th:first-child, td:first-child {
            text-align: left;
        }
    </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incomes/Costs</title>
</head>
<body>
    <h1>Программа для работы с доходами и расходами.</h1>
    <form name="rb">
        <h3> Выберите, с чем желаете работать:</h3>
        <input type="radio" name="typeOfInfo" checked="checked" value="Category" />Категории<br/>
        <input type="radio" name="typeOfInfo" value="Income" />Доходы<br />
        <input type="radio" name="typeOfInfo" value="Cost" />Расходы<br />
    </form>
    <form name = "addOrUpdateForm"></form>
    <form name = "rbTypeGroup"></form>
    <form name="tb"></form>
    <script>

        // Метод для добавления объекта строкой в таблицу
        function AddRowToTable(info) {
            const tr = document.createElement("tr"); // Создаём новую строку
            // Перебираем все свойства объекта
            for (var key in info) {
                const newTd = document.createElement("td"); // Создаём новую ячейку
                newTd.append(info[key]); // Добавляем к ней данные
                tr.append(newTd); // Добавляем её к строке
            }
            // Выводим строку
            return tr;
        }

        function ClearTable() {
            tb.innerHTML = "";
        }

        // Метод для удаления типа транзакции
        function DeleteTypeFromTransaction(transactions){
            for (val of transactions){
                delete val["type"];
            }
        }

        // Метод для создания таблицы с полученным массивом заголовков
        function CreateTable(columns) {
            ClearTable();
            // Создаём таблицу
            var table = document.createElement("table");
            var caption = document.createElement("caption");
            caption.textContent = typeInfo;
            table.append(caption);
            // Перебираем все элементы массива
            columns.forEach(column => {
                var th = document.createElement("th"); // Создаём заголвок
                th.append(column); // Добавляем название
                table.append(th); // Добавляем заголовок в общее заглавие
            });
            tb.append(table); // Добавляем таблицу на форму
        }

        function ClearRbTypeGroup(){
            rbTypeGroup.innerHTML="";
        }

        function CreateInput(type, name){
            var input = document.createElement("input");
            input.type = type;
            input.name = name;
            return input;
        }

        function CreateRb(name, value){
            var rb = CreateInput("radio", name);
            rb.value = value;
            return rb;
        }

        function CreateTb(name){
            var tb = CreateInput("text", name);
            tb.disabled = true;
            return tb;
        }

        function CreateBtn(name, value, click){
            var btn = CreateInput("button", name);
            btn.value = value;
            btn.disabled = true;
            btn.addEventListener("click", click); 
            return btn;
        }

        function BtByCategoryClick(e){
            const periodStart = rbTypeGroup.periodStart.value;
            const periodStop = rbTypeGroup.periodStop.value;
            if (rb.typeOfInfo[1].checked){
                GetIncomesByCategoryAndPeriod(periodStart, periodStop);
            }
            else if (rb.typeOfInfo[2].checked){
                GetCostsByCategoryAndPeriod(periodStart, periodStop);
            }
        }

        function RbTypeOfGrouppingClick(e){
            var type = e.target.value;
            if (type === "byMonth"){
                rbTypeGroup.periodStart.disabled = true;
                rbTypeGroup.periodStop.disabled = true;
                rbTypeGroup.Do.disabled = true;
                if (rb.typeOfInfo[1].checked){
                    GetIncomesByMonth();
                }
                else if (rb.typeOfInfo[2].checked){
                    GetCostsByMonth();
                }
            }
            else {
                rbTypeGroup.periodStart.disabled = false;
                rbTypeGroup.periodStop.disabled = false;
                rbTypeGroup.Do.disabled = false;
            }
        }
        function CreateRbTypeGroup() {
            ClearRbTypeGroup();
            var h3 = document.createElement("h3");
            h3.append("Тип группировки вывода");
            rbTypeGroup.append(h3);
            var rb1 = CreateRb("typeOfGroup", "byMonth");
            rb1.checked = true;
            rbTypeGroup.append(rb1);
            rbTypeGroup.append("По месяцам");
            rbTypeGroup.append(document.createElement("br"));
            rbTypeGroup.append(CreateRb("typeOfGroup", "byCategory"));
            rbTypeGroup.append("По категориям за указанный период (введите период в поля ниже в формате ##.##.####):");
            rbTypeGroup.append(document.createElement("br"));
            rbTypeGroup.append("С: ");
            rbTypeGroup.append(CreateTb("periodStart"));
            rbTypeGroup.append(" По: ");
            rbTypeGroup.append(CreateTb("periodStop"));
            rbTypeGroup.append(CreateBtn("Do", "Выполнить", BtByCategoryClick));
            for (var i=0; i<rbTypeGroup.typeOfGroup.length; i++){
                rbTypeGroup.typeOfGroup[i].addEventListener("click", RbTypeOfGrouppingClick);
            }
        }
        function BtnCreateValueClick(e) {

        }

        function BtnResetValueClick(e) {
            var elements = addOrUpdateForm.elements;
            for (var i = 0; i < elements.length; i++){
                if (elements[i].type === "text"){
                    elements[i].value = "";
                }
            }
        }

        function ClearInputForm(){
            addOrUpdateForm.innerHTML = "";
        }

        function CreateInputCategory() {
            ClearInputForm();
            var h3 = document.createElement("h3");
            h3.append("Создание/редактирование записи");
            addOrUpdateForm.append(h3);
            var id = CreateInput("hidden", "id");
            id.value = "0";
            addOrUpdateForm.append(id);
            var label = document.createElement("label");
            label.setAttribute("for", "inputCategory");
            label.textContent = "Категория: ";
            addOrUpdateForm.append(label);
            var inputCategory = CreateInput("text", "inputCategory");
            addOrUpdateForm.append(inputCategory);
            addOrUpdateForm.append(document.createElement("br"));
            var createValueButton = CreateBtn("createBtn", "Создать", BtnCreateValueClick);
            createValueButton.disabled = false;
            addOrUpdateForm.append(createValueButton);
            var resetValueButton = CreateBtn("resetBtn", "Очистить", BtnResetValueClick);
            resetValueButton.disabled = false;
            addOrUpdateForm.append(resetValueButton);
        }

        async function GetSomeValues(stringUrl, isTransaction) {
            // отправляет запрос и получаем ответ
            const response = await fetch(stringUrl, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            // если запрос прошел нормально
            if (response.ok === true) {
                // получаем данные
                const values = await response.json();
                if (isTransaction === true){
                    DeleteTypeFromTransaction(values);
                }
                ClearTable();
                CreateTable(cols);
                var table = document.querySelector("table");
                values.forEach(value => {
                    // добавляем полученные элементы в таблицу
                    table.append(AddRowToTable(value));
                });
            }
        }
        
        async function GetCategories() {
            GetSomeValues("/category", false);
        }
        
        async function GetIncomesByMonth() {
            GetSomeValues("/income/bymonth", true);
        }
        
        async function GetCostsByMonth() {
            GetSomeValues("/cost/bymonth", true);
        }

        async function GetIncomesByCategoryAndPeriod(periodStart, periodStop) {
            GetSomeValues("/income/bycategory/"+periodStart+"&"+periodStop, true);
        }

        async function GetCostsByCategoryAndPeriod(periodStart, periodStop) {
            GetSomeValues("/cost/bycategory/"+periodStart+"&"+periodStop, true);
        }

        
        // Добавление пользователя
        async function CreateUser(userName, userAge) {
            const response = await fetch("api/users", {
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: userName,
                    age: parseInt(userAge, 10)
                })
            });
            if (response.ok === true) {
                const user = await response.json();
                reset();
                document.querySelector("tbody").append(row(user));
            }
        }

        // Метод события нажатия на РБ
        function RbTypeOfInfoClick(e) {
            var type = e.target.value;
            if (type === "Category") {
                ClearRbTypeGroup();
                cols = ["Id", "Название"];
                typeInfo = "Категории";
                GetCategories();
            }
            else if (type === "Income") {
                CreateRbTypeGroup()
                cols = ["Id", "Категория", "Сумма", "Комментарий", "Дата"];
                typeInfo = "Доходы";
                GetIncomesByMonth();
            }
            else {
                CreateRbTypeGroup()
                cols = ["Id", "Категория", "Сумма", "Комментарий", "Дата"];
                typeInfo = "Расходы";
                GetCostsByMonth();
            }
        }
        // Главная часть программы
        var cols = ["Id", "Название"];
        var typeInfo = "Категории";
        for (var i = 0; i < rb.typeOfInfo.length; i++) {
            rb.typeOfInfo[i].addEventListener("click", RbTypeOfInfoClick);
        }
        GetCategories();
        CreateInputCategory();
    </script>
</body>
</html>